@model ProfileViewModel

@{
    ViewData["Title"] = "–ü—Ä–æ—Ñ–∏–ª—å";
}

<div class="fade-in">
    <div class="mb-5">
        <h2 class="mb-3">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
        <div style="height: 4px; width: 100px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border-radius: 2px;"></div>
    </div>

    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card" style="border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);">
                <div class="card-body p-4">
                    <h4 class="mb-4">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h4>
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3">
                            <span style="font-size: 2rem; margin-right: 1rem;">üë§</span>
                            <div>
                                <div class="text-muted" style="font-size: 0.9rem;">–ò–º—è</div>
                                <div style="font-size: 1.2rem; font-weight: 600;">@(Model.User.FullName ?? Model.User.UserName)</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span style="font-size: 2rem; margin-right: 1rem;">üìß</span>
                            <div>
                                <div class="text-muted" style="font-size: 0.9rem;">Email</div>
                                <div style="font-size: 1.2rem; font-weight: 600;">@Model.User.Email</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a asp-action="ChangePassword" class="btn btn-primary">
                            üîê –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* ------------------------------------------------------------------------------------------------------ *@
    @* --- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù–ù–´–ï –ë–ò–õ–ï–¢–´ --- *@
    @* ------------------------------------------------------------------------------------------------------ *@
    
    <div class="mt-5">
        <h4 class="mb-4">
            <span style="border-left: 4px solid var(--primary-color); padding-left: 1rem;">
                ‚è≥ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã
            </span>
        </h4>
        @if (Model.ReservedTickets.Any())
        {
            @* –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –±–∏–ª–µ—Ç—ã –ø–æ SessionId, —á—Ç–æ–±—ã –æ–ø–ª–∞—á–∏–≤–∞—Ç—å –≤—Å—é –±—Ä–æ–Ω—å —Ü–µ–ª–∏–∫–æ–º *@
          
                var groupedReservedTickets = Model.ReservedTickets
                    .GroupBy(t => t.Session.Id)
                    .OrderBy(g => g.First().Session.DateTime);
            

            <div class="row g-3">
                @foreach (var group in groupedReservedTickets)
                {
                    var firstTicket = group.First();
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ ID –±–∏–ª–µ—Ç–æ–≤ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é –æ–ø–ª–∞—Ç—ã
                    var allTicketsInGroup = string.Join(",", group.Select(t => t.Id));
                    var totalTickets = group.Count();
                    var totalPrice = group.Sum(t => t.Price);

                    <div class="col-md-6 col-lg-4">
                        <div class="card border-warning" style="border-radius: 15px;">
                            <div class="card-body">
                                <h5 class="mb-3 text-warning">üé¨ @firstTicket.Session.Movie.Title <span class="badge bg-danger ms-2">–ë–†–û–ù–¨</span></h5>
                                
                                <div class="mb-2">
                                    <small class="text-muted">üïê –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</small><br>
                                    <strong>@firstTicket.Session.DateTime.ToString("dd.MM.yyyy HH:mm")</strong>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">üìç –ó–∞–ª:</small><br>
                                    <strong>@firstTicket.Session.Hall.Name</strong>
                                </div>
                                
                                <h6 class="mt-3 mb-2">ü™ë –í–∞—à–∏ –º–µ—Å—Ç–∞:</h6>
                                <p class="text-break" style="font-size: 0.9rem;">
                                    @foreach (var ticket in group.OrderBy(t => t.Row).ThenBy(t => t.SeatNumber))
                                    {
                                        <span class="badge bg-secondary me-1 mb-1">–†—è–¥ @ticket.Row, –ú–µ—Å—Ç–æ @ticket.SeatNumber</span>
                                    }
                                </p>

                                <div class="alert alert-warning text-center mt-3 p-2">
                                    <strong>–ò—Ç–æ–≥–æ: @totalTickets –º–µ—Å—Ç, @totalPrice.ToString("0.00") ‚ÇΩ</strong>
                                </div>

                                <button type="button" 
                                        class="btn btn-success w-100"
                                        data-ticket-ids="@allTicketsInGroup"
                                        onclick="confirmPaymentFromProfile(this)">
                                    üí≥ –û–ø–ª–∞—Ç–∏—Ç—å (@totalPrice.ToString("0.00") ‚ÇΩ)
                                </button>
                                
                                <small class="text-muted d-block text-center mt-2">
                                    –ë—Ä–æ–Ω—å –∞–∫—Ç–∏–≤–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
                                </small>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-secondary text-center">
                <h5>‚è≥ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.</h5>
                <p class="mb-0">–ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ <a href="@Url.Action("Index", "Home")" style="color: var(--secondary-color);">—Ñ–∏–ª—å–º–æ–≤ –≤ –ø—Ä–æ–∫–∞—Ç–µ</a>!</p>
            </div>
        }
    </div>
    
    @* ------------------------------------------------------------------------------------------------------ *@
    @* --- –°–µ–∫—Ü–∏—è –ö–£–ü–õ–ï–ù–ù–´–ï –ë–ò–õ–ï–¢–´ (–í–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥) --- *@
    @* ------------------------------------------------------------------------------------------------------ *@

    <div class="mt-5">
        <h4 class="mb-4">
            <span style="border-left: 4px solid var(--primary-color); padding-left: 1rem;">
                üé´ –ú–æ–∏ –±–∏–ª–µ—Ç—ã
            </span>
        </h4>
        @if (Model.Tickets.Any())
        {
            <div class="row g-3">
                @foreach (var ticket in Model.Tickets)
                {
                    <div class="col-md-6 col-lg-4">
                        <div class="card session-card" style="border-radius: 15px;">
                            <div class="card-body">
                                <h5 class="mb-3">üé¨ @ticket.Session.Movie.Title</h5>
                                <div class="mb-2">
                                    <small class="text-muted">üïê –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</small><br>
                                    <strong>@ticket.Session.DateTime.ToString("dd.MM.yyyy HH:mm")</strong>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">üìç –ó–∞–ª:</small><br>
                                    <strong>@ticket.Session.Hall.Name</strong>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">ü™ë –ú–µ—Å—Ç–æ:</small><br>
                                    <strong>–†—è–¥ @ticket.Row, –ú–µ—Å—Ç–æ @ticket.SeatNumber</strong>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">üéüÔ∏è –ö–æ–¥ –±–∏–ª–µ—Ç–∞:</small><br>
                                    <strong style="color: var(--primary-color); font-family: monospace;">@ticket.TicketCode</strong>
                                </div>
                                <a href="@Url.Action("Ticket", "Booking", new { id = ticket.Id })" class="btn btn-primary w-100">
                                    –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∏–ª–µ—Ç–∞ ‚Üí
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info text-center">
                <h5>üé´ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤</h5>
                <p class="mb-0">–ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ <a href="@Url.Action("Index", "Home")" style="color: var(--primary-color);">—Ñ–∏–ª—å–º–æ–≤ –≤ –ø—Ä–æ–∫–∞—Ç–µ</a>!</p>
            </div>
        }
    </div>
</div>

@* ------------------------------------------------------------------------------------------------------ *@
@* --- –°–ö–†–ò–ü–¢–´: –§—É–Ω–∫—Ü–∏—è –æ–ø–ª–∞—Ç—ã (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å SelectSeats) --- *@
@* ------------------------------------------------------------------------------------------------------ *@
@section Scripts {
    <script>
        async function confirmPaymentFromProfile(buttonElement) {
            const ticketIdsStr = buttonElement.getAttribute('data-ticket-ids');
            if (!ticketIdsStr) {
                alert('–ù–µ—Ç ID –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã');
                return;
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
            const initialText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É ID –≤ –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª
            const ticketIds = ticketIdsStr.split(',').map(id => parseInt(id));

            try {
                // –í—ã–∑—ã–≤–∞–µ–º —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, —á—Ç–æ –∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç
                const response = await fetch('/Booking/ConfirmPayment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ticketIds)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ë–∏–ª–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.');
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–µ—Ä–≤–æ–≥–æ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
                    if (result.tickets && result.tickets.length > 0) {
                        window.location.href = `/Booking/Ticket/${result.tickets[0].id}`;
                    } else {
                        // –ï—Å–ª–∏ –±–∏–ª–µ—Ç—ã –Ω–µ –≤–µ—Ä–Ω—É–ª–∏—Å—å, –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                        window.location.href = '/Account/Profile';
                    }
                } else {
                    alert('‚ùå ' + (result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã.'));
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    buttonElement.disabled = false;
                    buttonElement.textContent = initialText;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, –µ—Å–ª–∏ –±—Ä–æ–Ω—å –∏—Å—Ç–µ–∫–ª–∞
                    if (result.message && (result.message.includes('–∏—Å—Ç–µ–∫–ª–∞') || result.message.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'))) {
                         window.location.reload();
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ.');
                buttonElement.disabled = false;
                buttonElement.textContent = initialText;
            }
        }
    </script>
}