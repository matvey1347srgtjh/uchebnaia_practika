@model CinemaApp.ViewModels.BookingViewModel

@{
    ViewData["Title"] = "–í—ã–±–æ—Ä –º–µ—Å—Ç";
}

<div class="fade-in mt-5">
    <div class="mb-4">
        <h2 class="mb-3">üé¨ @Model.MovieTitle</h2>
        <div class="d-flex flex-wrap gap-3 mb-4">
            <div class="badge" style="background: rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; font-size: 1rem;">
                üïê @Model.SessionDateTime.ToString("dd.MM.yyyy HH:mm")
            </div>
            <div class="badge" style="background: rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; font-size: 1rem;">
                üìç @Model.HallName
            </div>
            <div class="badge" style="background: linear-gradient(135deg, var(--secondary-color), #ff9800); color: #000; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: bold;">
                üí∞ @Model.Price.ToString("0.00") ‚ÇΩ –∑–∞ –º–µ—Å—Ç–æ
            </div>
        </div>
    </div>

    <div class="seat-map-container">
        <div class="text-center mb-4">
            <div class="screen">
                –≠–ö–†–ê–ù
            </div>
        </div>

        <div id="seatMap" class="seat-map mb-4">
            @for (int row = 1; row <= Model.HallRows; row++)
            {
                <div class="seat-row">
                    <div class="seat-label">–†—è–¥ @row</div>
                    <div class="d-flex justify-content-center gap-1 flex-wrap">
                        @for (int seat = 1; seat <= Model.HallSeatsPerRow; seat++)
                        {
                            var seatStatus = Model.Seats.FirstOrDefault(s => s.Row == row && s.SeatNumber == seat);
                            var isAvailable = seatStatus?.IsAvailable ?? true;
                            var isReserved = seatStatus?.IsReserved ?? false;
                            var isSold = seatStatus?.IsSold ?? false;
                            var seatId = $"{row}-{seat}";

                            string seatClass = "seat btn btn-sm ";
                            if (isSold)
                            {
                                seatClass += "btn-danger";
                            }
                            else if (isReserved)
                            {
                                seatClass += "btn-warning";
                            }
                            else
                            {
                                seatClass += "btn-success";
                            }

                            <button type="button" 
                                    class="@seatClass" 
                                    data-row="@row" 
                                    data-seat="@seat"
                                    data-seat-id="@seatId"
                                    @(isSold || isReserved ? "disabled" : "")
                                    onclick="selectSeat('@seatId', @isAvailable.ToString().ToLower())"
                                    title="–†—è–¥ @row, –ú–µ—Å—Ç–æ @seat">
                                @seat
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="seat-legend">
            <div class="legend-item">
                <div class="legend-seat btn-success"></div>
                <span>–°–≤–æ–±–æ–¥–Ω–æ</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat btn-warning"></div>
                <span>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat btn-danger"></div>
                <span>–ó–∞–Ω—è—Ç–æ</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat btn-primary"></div>
                <span>–í—ã–±—Ä–∞–Ω–æ</span>
            </div>
        </div>
    </div>

    <div class="selected-seats-info" id="selectedSeatsInfo" style="display: none;">
        <h5 class="mb-3">üé´ –í—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:</h5>
        <div id="selectedSeatsList" class="mb-3"></div>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="total-price" id="totalPrice">–ò—Ç–æ–≥–æ: 0 ‚ÇΩ</div>
            </div>
            <div>
                <button type="button" class="btn btn-primary btn-lg me-2" id="reserveBtn" onclick="reserveSeats()" disabled>
                    üîí –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button type="button" class="btn btn-success btn-lg" id="payBtn" onclick="confirmPayment()" style="display: none;">
                    üí≥ –û–ø–ª–∞—Ç–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="sessionId" value="@Model.SessionId" />
<input type="hidden" id="pricePerSeat" value="@Model.Price" />
<input type="hidden" id="reservedTicketIds" />

@section Scripts {
    <script>
        let selectedSeats = [];
        let reservedTicketIds = [];

        function selectSeat(seatId, isAvailable) {
            if (!isAvailable) {
                return;
            }

            const index = selectedSeats.indexOf(seatId);
            const seatButton = document.querySelector(`[data-seat-id="${seatId}"]`);
            const selectedSeatsInfo = document.getElementById('selectedSeatsInfo');

            if (index > -1) {
                selectedSeats.splice(index, 1);
                seatButton.classList.remove('btn-primary');
                seatButton.classList.add('btn-success');
            } else {
                selectedSeats.push(seatId);
                seatButton.classList.remove('btn-success');
                seatButton.classList.add('btn-primary');
            }

            updateSelectedSeatsDisplay();
            
            if (selectedSeats.length > 0) {
                selectedSeatsInfo.style.display = 'block';
            } else {
                selectedSeatsInfo.style.display = 'none';
            }
        }

        function updateSelectedSeatsDisplay() {
            const listDiv = document.getElementById('selectedSeatsList');
            const totalPriceEl = document.getElementById('totalPrice');
            const reserveBtn = document.getElementById('reserveBtn');
            const pricePerSeat = parseFloat(document.getElementById('pricePerSeat').value);

            if (selectedSeats.length === 0) {
                listDiv.innerHTML = '<p class="text-muted">–ú–µ—Å—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>';
                totalPriceEl.textContent = '–ò—Ç–æ–≥–æ: 0 ‚ÇΩ';
                reserveBtn.disabled = true;
            } else {
                listDiv.innerHTML = selectedSeats.map(seat => {
                    const [row, seatNum] = seat.split('-');
                    return `<span class="badge me-2 mb-2" style="background: var(--primary-color); padding: 0.75rem 1rem; font-size: 1rem;">–†—è–¥ ${row}, –ú–µ—Å—Ç–æ ${seatNum}</span>`;
                }).join('');
                const total = selectedSeats.length * pricePerSeat;
                totalPriceEl.textContent = `–ò—Ç–æ–≥–æ: ${total.toFixed(2)} ‚ÇΩ`;
                reserveBtn.disabled = false;
            }
        }

        async function reserveSeats() {
            if (selectedSeats.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –º–µ—Å—Ç–æ');
                return;
            }

            const sessionId = document.getElementById('sessionId').value;

            try {
                const response = await fetch(`/Booking/ReserveSeats?sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ selectedSeats: selectedSeats })
                });

                const result = await response.json();

                if (result.success) {
                    reservedTicketIds = result.ticketIds;
                    document.getElementById('reservedTicketIds').value = reservedTicketIds.join(',');
                    document.getElementById('reserveBtn').style.display = 'none';
                    document.getElementById('payBtn').style.display = 'inline-block';
                    alert('‚úÖ –ú–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã! –£ –≤–∞—Å –µ—Å—Ç—å 5 –º–∏–Ω—É—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã.');
                } else {
                    alert('‚ùå ' + (result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–µ—Å—Ç'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏');
            }
        }

        async function confirmPayment() {
            const ticketIdsStr = document.getElementById('reservedTicketIds').value;
            if (!ticketIdsStr) {
                alert('–ù–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤');
                return;
            }

            const ticketIds = ticketIdsStr.split(',').map(id => parseInt(id));

            try {
                const response = await fetch('/Booking/ConfirmPayment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ticketIds)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!');
                    // Redirect to ticket page or profile
                    if (result.tickets && result.tickets.length > 0) {
                        window.location.href = `/Booking/Ticket/${result.tickets[0].id}`;
                    } else {
                        window.location.href = '/Account/Profile';
                    }
                } else {
                    alert('‚ùå ' + (result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ');
            }
        }
    </script>
}
